{"componentChunkName":"component---src-templates-blog-post-js","path":"/2019-04-13-plex-docker-compose/","result":{"data":{"site":{"siteMetadata":{"title":"AL's Blog"}},"markdownRemark":{"id":"b205c78a-9733-5c26-926f-58e9a8a45cf0","excerpt":"So recently I have been using docker extensively at work, primarily for setting up/improving a local dev environment, as well as running some containers on AWS…","html":"<p>So recently I have been using docker extensively at work, primarily for setting up/improving a local dev environment, as well as running some containers on AWS ECS.</p>\n<p>To be honest, I initially didn’t quite understand what docker was used for. I mean, “containers”? Why not just use a VM? But once it really clicked in my head, whoa, containers. They’re awesome.</p>\n<p>If I had to distill what I discovered about docker into a few key points, it would be the following:</p>\n<ol>\n<li>It lets you create isolated environments (aka containers), each with it’s own set of dependencies (aka no more conflicting dependencies!)</li>\n<li>You can configure these environments as a document, and then share these documents with others.</li>\n<li>Given these documents, you can easily and reliably reproduce these environments</li>\n<li>You don’t need to manually install dependencies, etc. docker handles that for you!</li>\n<li>Unlike a VM, docker containers are NOT using virtualized hardware, etc. Docker uses cgroups and namespaces to isolate the environments from each other, but they are still directly issuing calls to the host linux kernel. This means containers are more like programs; they spin up fast, are cheap to stop and start, and don’t incur the performance overhead of running a virtual machine</li>\n</ol>\n<p>This enables some pretty powerful behavior.</p>\n<p>For example, I can spin up a vanilla linux server with a fresh OS install. Once you install docker on it, you can then feed docker some dockerfiles, it can then use those dockerfiles to spin up a bunch of isolated environments (such as Postgresql database, a rails web server, a plex server, pretty much anything with a <a href=\"https://hub.docker.com/\">dockerfile</a>).</p>\n<p>Each environment will have their own isolated dependencies, and you can even set up networking, port forwarding, etc, between the host machine and these environments! And this is portable to any other linux machine, since all you need on other machines is docker and whatever dockerfiles you used before.</p>\n<p>Since docker makes setting up an environment both extremely simple and reproduceable, it seemed like a perfect tool to setup a Plex server.</p>\n<p>Lo and behold, plex already has an <a href=\"https://hub.docker.com/r/plexinc/pms-docker/\">official docker image</a>, which should theoretically make it extremely easy to setup a plex server.</p>\n<p>Unfortunately, Plex inc doesn’t officially provide a <code class=\"language-text\">docker-compose.yml</code> config file, which would have made it even easier to setup the server. It would have been as simple as installing docker, downloading the repo, and running the command <code class=\"language-text\">docker-compose up</code> in terminal. Alas, some manual config is still needed.</p>\n<p>The final docker-compose.yml file I came up with is:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3.7\"</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">plex</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> plexinc/pms<span class=\"token punctuation\">-</span>docker\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> plex\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> TZ=America/New_York\n      <span class=\"token punctuation\">-</span> PLEX_CLAIM=(insert claim token here)\n    <span class=\"token key atrule\">network_mode</span><span class=\"token punctuation\">:</span> host\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> /path/on/host/to/save/to<span class=\"token punctuation\">:</span>/config\n      <span class=\"token punctuation\">-</span> /path/on/host/to/save/transcodes/to<span class=\"token punctuation\">:</span>/transcode\n      <span class=\"token punctuation\">-</span> /path/on/host/to/save/data/to<span class=\"token punctuation\">:</span>/data</code></pre></div>\n<p>Seems simple enough, let’s explain each part:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> plexinc/pms<span class=\"token punctuation\">-</span>docker\n<span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> plex\n<span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped</code></pre></div>\n<p>These should be fairly obvious, these specify where to get the docker image from, and to restart the container unless you manually issue it a stop command.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> TZ=America/New_York\n  <span class=\"token punctuation\">-</span> PLEX_CLAIM=(insert claim token here)</code></pre></div>\n<p>These are environment variables that are passed into the plex server once you spin it up. The CLAIM token is provided on the plex website, which you’ll need to setup the server.</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">network_mode</span><span class=\"token punctuation\">:</span> host</code></pre></div>\n<p>This part is related to how docker handles networking. If you specify <code class=\"language-text\">host</code>, docker will use ports on the host machine, and map them to to the running container’s ports.</p>\n<p>Now you may be thinking that this can be pretty dangerous. I mean, naively mapping all ports that the container uses to the same ports on the host? Sounds like it can be trouble.</p>\n<p>Docker actually provides a neat feature related to this, where you can essentially declare an isolated network that is independent of your local host machine. The docker container will expose it’s ports to the local network, and are NOT mapped to the ports on the host machine unless you explicitly provide a mapping. So if the <code class=\"language-text\">docker-compose.yml</code> was configured to use a network that, in this example, we’ll call <code class=\"language-text\">example_network</code>, it would look something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">plex</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> plexinc/pms<span class=\"token punctuation\">-</span>docker\n    <span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> example_network\n    <span class=\"token comment\"># these ports need to be accessible on the host,</span>\n    <span class=\"token comment\"># otherwise plex won't work</span>\n    <span class=\"token comment\"># the left number is the port on the host machine</span>\n    <span class=\"token comment\"># the right number is the port on the container</span>\n    <span class=\"token key atrule\">ports</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> 32400<span class=\"token punctuation\">:</span>32400/tcp\n      <span class=\"token punctuation\">-</span> 3005<span class=\"token punctuation\">:</span>3005/tcp\n      <span class=\"token punctuation\">-</span> 8324<span class=\"token punctuation\">:</span>8324/tcp\n      <span class=\"token punctuation\">-</span> 32469<span class=\"token punctuation\">:</span>32469/tcp\n      <span class=\"token punctuation\">-</span> 1900<span class=\"token punctuation\">:</span>1900/udp\n      <span class=\"token punctuation\">-</span> 32410<span class=\"token punctuation\">:</span>32410/udp\n      <span class=\"token punctuation\">-</span> 32412<span class=\"token punctuation\">:</span>32412/udp\n      <span class=\"token punctuation\">-</span> 32413<span class=\"token punctuation\">:</span>32413/udp\n      <span class=\"token punctuation\">-</span> 32414<span class=\"token punctuation\">:</span>32414/udp\n<span class=\"token key atrule\">networks</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> example_network<span class=\"token punctuation\">:</span></code></pre></div>\n<p>And finally, the last part:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> /path/on/host/to/save/to/<span class=\"token punctuation\">:</span>/config\n  <span class=\"token punctuation\">-</span> /path/on/host/to/save/transcodes/to/<span class=\"token punctuation\">:</span>/transcode\n  <span class=\"token punctuation\">-</span> /path/on/host/to/save/data/to/<span class=\"token punctuation\">:</span>/data</code></pre></div>\n<p>the <code class=\"language-text\">/path/on/host/</code> is exactly what it sounds like: the location where you want the container to save stuff to. To be more specific, this is something called a <a href=\"https://docs.docker.com/storage/bind-mounts/\">bind mount</a>, where a directory on your local host machine is bound to the target directory inside the container. Since you want to be able to reliably add/remove media to your plex server, you need to decide on which directory you want to mount into the container.</p>\n<p>if this looks confusing to you, think of it this way:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> (file path on host)<span class=\"token punctuation\">:</span>(file path in the container)</code></pre></div>\n<p>plex expects media to be saved in the <code class=\"language-text\">/data</code> directory in the container, so you need to map some directory on your own machine to that directory in the container.</p>\n<p>So after all that, the end result is that you can run <code class=\"language-text\">docker-compose up</code> in terminal, and it’ll do the following:</p>\n<ul>\n<li>download all dependencies needed for your plex server</li>\n<li>inject whatever environment variables you specified</li>\n<li>hook up the container ports to your host machine</li>\n<li>map file volumes between the host and container</li>\n<li>and spin up a fully working, live plex server!</li>\n</ul>","frontmatter":{"title":"Running a Plex Media Server with Docker Compose","date":"April 13, 2019","description":null}},"previous":null,"next":{"fields":{"slug":"/2019-04-25-compound-components/"},"frontmatter":{"title":"Building Flexible and Reusable React Compound Components"}}},"pageContext":{"id":"b205c78a-9733-5c26-926f-58e9a8a45cf0","previousPostId":null,"nextPostId":"7bdadd66-7e58-5150-a6ca-8186e02d4922"}},"staticQueryHashes":["2841359383","3257411868"]}