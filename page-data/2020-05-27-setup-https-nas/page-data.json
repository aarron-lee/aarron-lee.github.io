{"componentChunkName":"component---src-templates-blog-post-js","path":"/2020-05-27-setup-https-nas/","result":{"data":{"site":{"siteMetadata":{"title":"AL's Blog"}},"markdownRemark":{"id":"1559272e-f05e-5391-91e5-983b167ac42a","excerpt":"While I already had a decent understanding of how the internet works, I rarely had practical ways to apply that knowledge. Sure, I knew the terms “DNS”, “Name…","html":"<p>While I already had a decent understanding of how the internet works, I rarely had practical ways to apply that knowledge. Sure, I knew the terms “DNS”, “Name Servers”, “Firewalls”, etc, and generally knew how they all worked together, but I had never end-to-end configured a bare metal server to host a website. In retrospect, configuring a server from scratch proved to be a great learning experience.</p>\n<h2>Context:</h2>\n<p>I had an old $50 HP 8300 SFF desktop computer, an old but plenty-capable machine with it’s i5 intel processor and 8GB of RAM. I was already using it to host a Plex Media server, Calibre-Web server, and a few other web services on this machine. It had been chugging along for many months now, and has been great to work with.</p>\n<p>However, my past self had unfortunately set it up with desktop Ubuntu without SSH, which led to requiring the GUI for to administer this machine. Not being able to do remote administration was a constant friction point, especially since the device was in the far corner of my living room.</p>\n<h2>Goals:</h2>\n<p>So the goals I laid out were the following:</p>\n<ol>\n<li>Install Ubuntu Server LTS (at the time of this post, 20.04 LTS is the latest version)</li>\n<li>Setup SSH for remote administration</li>\n<li>Setup Nginx, a firewall, and port forwarding for to enable hosting a site</li>\n<li>Enable Dynamic DNS so that I could map a domain name to my server</li>\n<li>Setup HTTPS with a Let’s Encrypt certificate + autorenewal</li>\n<li>Host some static HTML via nginx and have a fully functional site up and running</li>\n</ol>\n<h2>Equipment:</h2>\n<ul>\n<li>Computer to use as a Server (an old desktop, laptop, etc)</li>\n<li>Internet Router where you can setup Port Forwarding</li>\n<li>Domain name via a registrar (I used Namecheap)</li>\n<li>USB/DVD/etc - for to setup OS install media. Use whatever is appropriate for your machine</li>\n<li>(optional, but recommended) Personal use computer for remote administration of the server (this personal computer must be able to SSH into remote machines)</li>\n</ul>\n<h2>Steps</h2>\n<p>Part 1: Setup your server</p>\n<ol>\n<li>Download and setup a Ubuntu Server USB installer</li>\n<li>Boot your server, and boot the installer via USB</li>\n<li>Install Ubuntu server, setup your login info, etc</li>\n<li>Once setup, you should be able to login to the device on boot</li>\n</ol>\n<p>Part 2: Setup SSH keys / Disable SSH Password login</p>\n<ol>\n<li>Create an SSH Key on the machine you’ll be using for remote administration</li>\n<li>Copy the public key file of your generated SSH key (by default, it’s at <code class=\"language-text\">~/.ssh/id_rsa.pub</code> on your machine). You will need to transfer a copy of this file to your server, how you choose to do so is up to you.</li>\n<li>Take the contents of the public key file, and appended it to the end of the <code class=\"language-text\">/home/username_here/.ssh/authorized_keys</code> file on the Server</li>\n<li>To test and make sure this worked, attempt to SSH into your server. To do so, first, figure out the server’s address on your local LAN (it should look something like <code class=\"language-text\">192.168.XX.XX</code>)</li>\n<li>after figuring out your server’s address on your local LAN, on your remote administration machine attempt the following:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ssh username_goes_here@server_LAN_address_here\ne.g.\nssh aarron@192.168.XX.XX</code></pre></div>\n<p>Since you setup SSH keys, it should auto-log you in.</p>\n<ol start=\"6\">\n<li>Once your SSH keys are setup, time to disable SSH password login. Edit your <code class=\"language-text\">/etc/ssh/sshd_config</code> file on your server, and find + change to the following:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">ChallengeResponseAuthentication no\nPasswordAuthentication no\nUsePAM no\nPermitRootLogin no</code></pre></div>\n<p>After saving your changes, run <code class=\"language-text\">sudo service sshd restart</code> and <code class=\"language-text\">sudo service ssh restart</code></p>\n<ol start=\"7\">\n<li>To verify the changes, attempt <code class=\"language-text\">ssh root@LAN_address_here</code>. It should fail</li>\n</ol>\n<p>Part 3: Setup NGINX, firewall, and port forwarding</p>\n<ol>\n<li>Install nginx with <code class=\"language-text\">sudo apt install nginx</code></li>\n<li>Start nginx with <code class=\"language-text\">sudo service nginx start</code></li>\n<li>To make sure it’s working, go to <code class=\"language-text\">http://192.168.XX.XX:80</code> in your browser, it should display the nginx default page. If you’d like to change the static HTML pages being served by nginx, you can change your files located at <code class=\"language-text\">/var/www/html</code>. If you want to host a web app, you’ll need to edit your <code class=\"language-text\">nginx.conf</code> file accordingly</li>\n<li>Once we confirmed that it’s working, we now need to setup a firewall (we’ll use a simple firewall, <code class=\"language-text\">ufw</code>. feel free to use whatever you’re comfortable with)</li>\n<li>run <code class=\"language-text\">sudo ufw enable</code>.</li>\n<li>enable SSH by running <code class=\"language-text\">sudo ufw allow ssh</code></li>\n<li>Check to see if the firewall is still working. If you revisit <code class=\"language-text\">http://192.168.XX.XX:80</code>, your firewall should now be blocking the standard HTTP port</li>\n<li>to reenable HTTP, run <code class=\"language-text\">sudo ufw allow http</code></li>\n<li>Revisit the url and make sure the webpage now renders</li>\n<li>Now that your server is properly serving HTTP requests on the expected port, we now need to port forward from your network gateway (e.g. your home router, etc) to your server. Look up how to port forward on your router, and forward port 80 to the server</li>\n<li>To verify that this worked, first figure out your public IP (you can visit <a href=\"https://domains.google.com/checkip\">https://domains.google.com/checkip</a>) in a browser. Then, in your browser, type in your public IP address, it should display the nginx default page.</li>\n</ol>\n<p>Part 4: Setup Domain Name</p>\n<ol>\n<li>Purchase a domain name of your choice from your preferred provider. I went with namecheap</li>\n<li>Setup a Dynamic DNS record according to your provider. Depending on your provider, there are different ways to do so. I’ll be detailing how to handle namecheap, specifically, in the following instructions</li>\n<li>Go to the <code class=\"language-text\">Advanced DNS</code> and enable Dynamic DNS. Copy down this password some place secure, you’ll need this later.</li>\n<li>On <code class=\"language-text\">Advanced DNS</code> page, create 2 dynamic DNS entries:</li>\n<li>Host: @, value: 127.0.0.1 (we’ll change this later), TTL: Automatic</li>\n<li>Host: www, value: 127.0.0.1 (same, we’ll change later), TTL: Automatic</li>\n</ol>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6691b8d195b663711bc84b196af80847/03073/dns.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.43037974683544%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAECBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAceagD//xAAYEAADAQEAAAAAAAAAAAAAAAABEBEAIf/aAAgBAQABBQLdBVq//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFxAAAwEAAAAAAAAAAAAAAAAAARARIP/aAAgBAQAGPwLFK//EABkQAQACAwAAAAAAAAAAAAAAAAEAEBFBUf/aAAgBAQABPyGZ4m1LY1//2gAMAwEAAgADAAAAEDAP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAGhABAAMAAwAAAAAAAAAAAAAAAQARUSExQf/aAAgBAQABPxBch7h6UkbWPFVkTJfYy2f/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Advanced DNS setup\"\n        title=\"Advanced DNS setup\"\n        src=\"/static/6691b8d195b663711bc84b196af80847/828fb/dns.jpg\"\n        srcset=\"/static/6691b8d195b663711bc84b196af80847/ff44c/dns.jpg 158w,\n/static/6691b8d195b663711bc84b196af80847/a6688/dns.jpg 315w,\n/static/6691b8d195b663711bc84b196af80847/828fb/dns.jpg 630w,\n/static/6691b8d195b663711bc84b196af80847/0ede0/dns.jpg 945w,\n/static/6691b8d195b663711bc84b196af80847/03073/dns.jpg 976w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<ol start=\"5\">\n<li>We’re going to setup dynamic DNS with <a href=\"https://github.com/ddclient/ddclient\">ddclient</a> in a Docker container. To do so, first install the docker daemon + other utils, including docker-compose (you can look up this part)</li>\n<li>Once you have docker installed, we’re going to use the following <code class=\"language-text\">docker-compose.yml</code> file:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"yml\"><pre class=\"language-yml\"><code class=\"language-yml\"><span class=\"token key atrule\">version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'3.7'</span>\n\n<span class=\"token key atrule\">services</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">ddclient</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">image</span><span class=\"token punctuation\">:</span> linuxserver/ddclient\n    <span class=\"token key atrule\">container_name</span><span class=\"token punctuation\">:</span> ddclient\n    <span class=\"token key atrule\">environment</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> PUID=1000\n      <span class=\"token punctuation\">-</span> PGID=1000\n      <span class=\"token punctuation\">-</span> TZ=America/New_York\n    <span class=\"token key atrule\">volumes</span><span class=\"token punctuation\">:</span>\n      <span class=\"token comment\"># NOTE: make sure to replace the filepath with a place</span>\n      <span class=\"token comment\"># where you want to store the ddclient config files</span>\n      <span class=\"token punctuation\">-</span> /filepath_on_server_machine<span class=\"token punctuation\">:</span>/config\n    <span class=\"token key atrule\">restart</span><span class=\"token punctuation\">:</span> unless<span class=\"token punctuation\">-</span>stopped</code></pre></div>\n<ol start=\"7\">\n<li>once your <code class=\"language-text\">docker-compose.yml</code> file is setup, run <code class=\"language-text\">sudo docker-compose up -d</code>, which should spin up a ddclient container.</li>\n<li>confirm that there is now a <code class=\"language-text\">ddclient.conf</code> file inside the filepath you specified on the server. Once you confirm that the file is there, run <code class=\"language-text\">sudo docker-compose down</code> to stop the contianer.</li>\n<li>Find the <code class=\"language-text\">namecheap</code> entry in the <code class=\"language-text\">ddclient.conf</code> file, and edit it to as follows:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">use=web, web=https://dynamicdns.park-your-domain.com/getip\nprotocol=namecheap\nserver=dynamicdns.park-your-domain.com\nlogin=your_url_goes_here\npassword=advanced_dns_password_here\n@, www</code></pre></div>\n<ol start=\"10\">\n<li>Save you changes, run <code class=\"language-text\">sudo docker-compose up -d</code> again. Run <code class=\"language-text\">sudo docker logs ddclient</code>, you should see a message similar to this:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">SUCCESS:  updating @: good: IP address set to your_public_ip_address\nSUCCESS:  updating www: good: IP address set to your_public_ip_address</code></pre></div>\n<p>Your Namecheap DNS entries should have also been updated to the new IP address. You should now be able to visit your url (no HTTPS yet)</p>\n<p>Part 5: setup SSL certificate for HTTPS</p>\n<ol>\n<li>Now that HTTP is working properly, we can now setup HTTPS.</li>\n<li>This part is fairly straightforward with <a href=\"https://certbot.eff.org/\">certbot</a>, which is what we’ll be using here.</li>\n<li>Before running certbot, edit your <code class=\"language-text\">server_name</code> in the <code class=\"language-text\">/etc/nginx/sites-available/default</code> file, as seen below:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"> # change server_name to have a list of your urls\n server_name your_root_url_without_www your_url_with_www\n e.g.\n server_name test.com www.test.com</code></pre></div>\n<p>Restart your nginx service after saving this change with <code class=\"language-text\">sudo service nginx restart</code></p>\n<ol start=\"4\">\n<li>after your server_name is updated, install certbot via the instructions at the official certbot site.</li>\n<li>after installation, run <code class=\"language-text\">sudo certbox --nginx</code>, and follow the prompts</li>\n<li>run <code class=\"language-text\">sudo ufw allow https</code>, and setup port forwarding on your router for port 443</li>\n<li>You should now have a valid SSL cert for your website, go revisit your website (but use <code class=\"language-text\">https</code> instead), and it should just work!</li>\n<li>(optional) you can enable HTTP2 by editing the following lines in your <code class=\"language-text\">nginx.conf</code> to include <code class=\"language-text\">http2</code>:</li>\n</ol>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">  listen [::]:443 http2 ssl ipv6only=on; # managed by Certbot\n  listen 443 http2 ssl; # managed by Certbot</code></pre></div>\n<ol start=\"9\">\n<li>if you setup HTTP2, don’t forget to restart the nginx service!</li>\n</ol>\n<p>And with that, you should be fully hosting a website on your own server in your living room!</p>","frontmatter":{"title":"Setting up a home server from scratch","date":"May 27, 2020","description":null}},"previous":{"fields":{"slug":"/2019-07-03-kubernetes-cheat-sheet/"},"frontmatter":{"title":"A Basic Cheat Sheet for Kubernetes terminology"}},"next":{"fields":{"slug":"/2021-02-24-ryzen-linux-laptop/"},"frontmatter":{"title":"My Search for an Ideal Linux Laptop"}}},"pageContext":{"id":"1559272e-f05e-5391-91e5-983b167ac42a","previousPostId":"cd0a698c-7909-5367-b979-55a18485ca8f","nextPostId":"8e2d90fe-3134-5273-b1a2-fc049905b5e0"}},"staticQueryHashes":["2841359383","3257411868"]}